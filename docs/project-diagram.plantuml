@startuml "FastBasket Delivery Platform Architecture"

!theme vibrant

title "Архитектура Платформы 'БыстраяКорзина'"
caption "Диаграмма компонентов и их взаимодействия"

' == 1. Слой Представления (UI) ==
package "Presentation Layer (UI)" #LightBlue {
  
  component "[Admin UI]" as AdminUI {
    [admin/.../page.tsx]
    [admin/.../_components/...]
  }

  component "[Catalog & Product UI]" as CatalogUI {
    [catalog/page.tsx]
    [product/[id]/page.tsx]
  }

  component "[Shared UI]" as SharedUI {
    [components/site-header.tsx]
    [components/cart.tsx]
    [contexts/cart-context.tsx]
  }
}

' == 2. Слой Серверных Действий ==
package "Server Actions" #LightCoral {
  [product.actions.ts]
  [category.actions.ts]
  [order.actions.ts]
  [log.actions.ts]
  [storage.actions.ts]
}

' == 3. Слой Сервисов (Бизнес-логика) ==
package "Service Layer (Business Logic)" #LightGreen {
  [products.service.ts]
  [categories.service.ts]
  [orders.service.ts]
  [weight-templates.service.ts]
  [storage.service.ts]
  [db.service.ts]
}

' == 4. Слой Утилит и Валидации ==
package "Utility & Validation Layer" #WhiteSmoke {
  
  package "Helpers" {
    [products/helpers.ts]
    [categories/helpers.ts]
    [weight-templates/helpers.ts]
  }
  
  package "Validation" {
    [schemas/product.schema.ts]
    [schemas/category.schema.ts]
    [schemas/weight-template.schema.ts]
    [utils/validate-db-row.ts]
  }
  
  package "Core Utils" {
    [env.ts (runMockOrReal)]
    [server-logger.ts]
    [types.ts]
  }
}

' == 5. Слой Доступа к Данным ==
package "Data Access Layer" #LightGray {
  database "PostgreSQL" as PG
  storage "Google Cloud Storage" as GCS
  
  package "Local Fallback" {
    [lib/mock-data.ts] as MockData
    [public/debug.log] as LogFile
  }

  [lib/db.ts]
}

' == 6. Слой AI и Наблюдаемости ==
package "AI & Observability Layer" #Thistle {
  [ai/genkit.ts]
  [ai/flows/qa-flow.ts]
}

' == 7. Слой Инфраструктуры ==
package "Infrastructure Layer" #LightSteelBlue {
  [next.config.ts]
  [apphosting.yaml]
  [lib/config.ts] as EnvConfig
}

' ===================================
' Связи между компонентами
' ===================================

' UI Layer -> Server Actions
AdminUI --> [product.actions.ts]
AdminUI --> [category.actions.ts]
AdminUI --> [log.actions.ts]
SharedUI --> [order.actions.ts]

' Server Actions -> Service Layer (Делегирование)
[product.actions.ts] ..> [products.service.ts]
[category.actions.ts] ..> [categories.service.ts]
[order.actions.ts] ..> [orders.service.ts]
[log.actions.ts] ..> LogFile
[log.actions.ts] ..> "Google Cloud Logging" #LightGray
[storage.actions.ts] ..> [storage.service.ts]

' Service Layer -> Utility & Validation Layer
[products.service.ts] --> [products/helpers.ts]
[categories.service.ts] --> [categories/helpers.ts]
[weight-templates.service.ts] --> [weight-templates/helpers.ts]
[products.service.ts] --> [utils/validate-db-row.ts]
[categories.service.ts] --> [utils/validate-db-row.ts]
[products/helpers.ts] --> [schemas/product.schema.ts]
[categories/helpers.ts] --> [schemas/category.schema.ts]

' Service Layer -> Data Access Switcher
[products.service.ts] --> [env.ts (runMockOrReal)]
[categories.service.ts] --> [env.ts (runMockOrReal)]
[orders.service.ts] --> [env.ts (runMockOrReal)]

' Data Access Switcher -> Data Access Layer
[env.ts (runMockOrReal)] ..> [lib/db.ts] : "real mode"
[env.ts (runMockOrReal)] ..> MockData : "mock mode"

' Data Access Layer Connections
[lib/db.ts] --> PG
[storage.service.ts] --> GCS

' Logging Connections
[server-logger.ts] --> LogFile
[server-logger.ts] --> "Google Cloud Logging" #LightGray

' AI Layer Connections
[ai/flows/qa-flow.ts] ..> [log.actions.ts] : "analyzes logs"
[ai/flows/qa-flow.ts] ..> [ai/genkit.ts]

' Infrastructure Connections
[lib/db.ts] --> EnvConfig
[apphosting.yaml] --> EnvConfig
[server-logger.ts] --> EnvConfig

' ===================================
' Легенда
' ===================================
legend left
  == **Кодировка Слоев** ==
  <color:LightBlue>■</color> Presentation Layer (UI)
  <color:LightCoral>■</color> Server Actions
  <color:LightGreen>■</color> Service Layer (Business Logic)
  <color:WhiteSmoke>■</color> Utility & Validation Layer
  <color:LightGray>■</color> Data Access Layer
  <color:Thistle>■</color> AI & Observability Layer
  <color:LightSteelBlue>■</color> Infrastructure Layer
  
  == **Типы Связей** ==
  **-->** : Прямая зависимость (импорт, вызов)
  **..>** : Непрямая или опциональная связь
end legend


@enduml
