@startuml
!theme spacelab

' =================================================================
' Global styles for a cleaner look
' =================================================================
skinparam shadowing false
skinparam RoundCorner 10
skinparam DefaultFontName "Roboto, Arial"
skinparam DefaultFontSize 12
skinparam ArrowColor #666666
skinparam ArrowThickness 1.5

skinparam component {
    BackgroundColor #FFFFFF
    BorderColor #444444
    BorderThickness 1.5
    FontColor #333333
    StereotypeFontColor #AAAAAA
}

skinparam package {
    BorderColor #888888
    BorderThickness 1
    FontColor #555555
    FontSize 14
    FontStyle bold
    StereotypeFontSize 11
    StereotypeFontColor #777777
}

' =================================================================
' Layers Definition
' =================================================================

package "Presentation Layer (UI)" #LightBlue {
    component "[Admin UI]" as AdminUI
    component "[Catalog & Product UI]" as CatalogUI
    component "[Cart & Checkout]" as CartUI
}

package "Server Actions" #LightCoral {
    component "[Product Actions]\n(product.actions.ts)" as ProductActions
    component "[Category Actions]\n(category.actions.ts)" as CategoryActions
    component "[Order Actions]\n(order.actions.ts)" as OrderActions
    component "[Log Actions]\n(log.actions.ts)" as LogActions
}

package "Service Layer" #LightGreen {
    component "[Products Service]\n(products.service.ts)" as ProductsService
    component "[Categories Service]\n(categories.service.ts)" as CategoriesService
    component "[Orders Service]\n(orders.service.ts)" as OrdersService
}

package "Utility & Validation Layer" #WhiteSmoke {
    component "[env.ts]\n(runMockOrReal)" as EnvHelper
    component "[Helpers]\n(helpers.ts)" as Helpers
    component "[DB Row Validator]\n(validate-db-row.ts)" as DbValidator
    component "[Schemas]\n(schemas/*.ts)" as Schemas
    component "[Server Logger]\n(server-logger.ts)" as ServerLogger
}

package "Data Access Layer (DAL)" #LightGray {
    database "[PostgreSQL]" as PostgresDB
    database "[Mock Data]\n(mock-data.ts)" as MockDataDB
    folder "[Google Cloud Storage]" as GCS
    folder "[Local Log Storage]\n(debug.log)" as LocalLog
}

package "AI & Observability Layer" #Thistle {
    component "[QA Flow]\n(qa-flow.ts)" as QaFlow
    component "[Genkit AI Tools]\n(readProjectLogs)" as AiTools
}

' =================================================================
' Relationships
' =================================================================

' --- UI to Actions (User triggers) ---
AdminUI --> ProductActions
AdminUI --> CategoryActions
CatalogUI ..> ProductActions
CartUI ..> OrderActions
AdminUI --> LogActions

' --- Actions to Services (Delegation) ---
ProductActions ..> ProductsService
CategoryActions ..> CategoriesService
OrderActions ..> OrdersService

' --- Services to Utilities (Core Logic) ---
ProductsService --> Helpers
ProductsService --> DbValidator
CategoriesService --> Helpers
CategoriesService --> DbValidator
OrdersService --> DbValidator

DbValidator --> Schemas

' --- Service Layer Data Flow (Mock/Real Switch) ---
note right of EnvHelper
  Determines whether to call
  the mock or real data source
  based on MOCK_DATA env var.
end note

ProductsService --> EnvHelper
CategoriesService --> EnvHelper
OrdersService --> EnvHelper

EnvHelper ..> PostgresDB : "if MOCK_DATA=false"
EnvHelper ..> MockDataDB : "if MOCK_DATA=true"

' --- Logging Flow ---
ServerLogger --> LocalLog : "(local dev)"
ServerLogger ..> PostgresDB : "(future cloud logging)"

' --- AI & Observability Flow (Vertical Slice) ---
QaFlow --> AiTools
AiTools --> LogActions
LogActions --> ServerLogger

' =================================================================
' Legend
' =================================================================
legend left
== Color Codes ==
<color:LightBlue>■</color> Presentation (UI Components)
<color:LightCoral>■</color> Server Actions (Next.js API)
<color:LightGreen>■</color> Service Layer (Business Logic)
<color:WhiteSmoke>■</color> Utilities & Validation
<color:LightGray>■</color> Data Access (DB, Storage)
<color:Thistle>■</color> AI & Observability

== Arrows ==
...> : Indirect / Optional
--> : Direct Dependency
endlegend

@enduml
